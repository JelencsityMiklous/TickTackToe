<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic-Tac-Toe - J√°t√©k</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
    <svg class="spaceship spaceship-1" width="80" height="40" viewBox="0 0 80 40" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 20 L25 15 L60 18 L75 20 L60 22 L25 25 L5 20Z" fill="#ccc" stroke="#fff" stroke-width="0.5"/>
    <path d="M60 18 L70 20 L60 22 L60 18Z" fill="#fff" opacity="0.8"/>
    <circle cx="30" cy="20" r="3" fill="#4af" opacity="0.6"/>
    <circle cx="40" cy="20" r="2" fill="#4af" opacity="0.6"/>
  </svg>
  
  <svg class="spaceship spaceship-2" width="100" height="50" viewBox="0 0 100 50" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 25 L30 20 L70 23 L90 25 L70 27 L30 30 L10 25Z" fill="#aaa" stroke="#fff" stroke-width="0.5"/>
    <path d="M70 23 L85 25 L70 27 L70 23Z" fill="#fff" opacity="0.7"/>
    <path d="M20 25 L30 22 L30 28 L20 25Z" fill="#ddd" opacity="0.5"/>
    <circle cx="35" cy="25" r="2" fill="#f44" opacity="0.6"/>
  </svg>
  
  <svg class="spaceship spaceship-3" width="60" height="30" viewBox="0 0 60 30" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 15 L20 12 L45 14 L55 15 L45 16 L20 18 L5 15Z" fill="#bbb" stroke="#fff" stroke-width="0.5"/>
    <path d="M45 14 L52 15 L45 16 L45 14Z" fill="#fff" opacity="0.8"/>
    <circle cx="25" cy="15" r="2" fill="#4f4" opacity="0.6"/>
  </svg>
<div class="container">
<div class="game-card">
<div class="game-header">
<h1>üéÆ Tic-Tac-Toe</h1>
<div class="room-info">
<span class="room-code">Szoba: <strong><%= roomCode %></strong></span>
</div>
</div>
 
      <div id="statusBar" class="status-bar">
        Csatlakoz√°s...
</div>
 
      <div id="playersInfo" class="players-info" style="display: none;">
<div class="player" id="player1">
<span class="symbol">‚ùå</span>
<span class="name">-</span>
</div>
<div class="vs">VS</div>
<div class="player" id="player2">
<span class="symbol">‚≠ï</span>
<span class="name">-</span>
</div>
</div>
 
      <div id="gameBoard" class="game-board">
<div class="cell" data-index="0"></div>
<div class="cell" data-index="1"></div>
<div class="cell" data-index="2"></div>
<div class="cell" data-index="3"></div>
<div class="cell" data-index="4"></div>
<div class="cell" data-index="5"></div>
<div class="cell" data-index="6"></div>
<div class="cell" data-index="7"></div>
<div class="cell" data-index="8"></div>
</div>
 
      <div class="game-controls">
<button id="rematchBtn" class="btn btn-secondary" style="display: none;">
          √öj j√°t√©k
</button>
<span id="rematchStatus" class="rematch-status"></span>
</div>
 
      <div class="actions">
<a href="/" class="btn btn-outline">Kil√©p√©s a lobbiba</a>
</div>
</div>
</div>
 
  <script src="/socket.io/socket.io.js"></script>
<script>
    const roomCode = '<%= roomCode %>';
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get('name');
 
    if (!playerName) {
      window.location.href = '/';
    }
 
    const socket = io();
    let mySymbol = null;
    let currentTurn = 'X';
    let gameStatus = 'waiting';
    let isSpectator = false;
 
    // DOM elemek
    const statusBar = document.getElementById('statusBar');
    const gameBoard = document.getElementById('gameBoard');
    const cells = document.querySelectorAll('.cell');
    const rematchBtn = document.getElementById('rematchBtn');
    const rematchStatus = document.getElementById('rematchStatus');
    const playersInfo = document.getElementById('playersInfo');
    const shareBtn = document.getElementById('shareBtn');
 
    // socket emit cstalakozas
    socket.emit('joinRoom', { playerName, roomCode });
 
    // szoba csatlakozas
    socket.on('roomJoined', (data) => {
      mySymbol = data.symbol;
      isSpectator = data.spectator || false;
 
      if (isSpectator) {
        statusBar.textContent = 'N√©z≈ëk√©nt csatlakozt√°l';
        statusBar.classList.add('spectator');
      } else {
        updatePlayers(data.players);
        playersInfo.style.display = 'flex';
        if (data.status === 'waiting') {
          statusBar.textContent = 'V√°rakoz√°s ellenf√©lre...';
        }
      }
    });
 
    // allapot
    socket.on('stateUpdate', (data) => {
      updateBoard(data.board);
      currentTurn = data.turn;
      gameStatus = data.status;
 
      if (data.status === 'playing') {
        if (isSpectator) {
          statusBar.textContent = `Folyamatban: ${currentTurn} k√∂vetkezik`;
        } else {
          statusBar.textContent = currentTurn === mySymbol 
            ? 'Te k√∂vetkezel!' 
            : `${currentTurn} j√°t√©kos k√∂vetkezik...`;
        }
        statusBar.className = 'status-bar';
        rematchBtn.style.display = 'none';
        rematchStatus.textContent = '';
      } else if (data.status === 'finished') {
        if (data.winner === 'draw') {
          statusBar.textContent = 'D√∂ntetlen!';
          statusBar.className = 'status-bar draw';
        } else {
          const isWinner = data.winner === mySymbol;
          statusBar.textContent = isSpectator 
            ? `üèÜ ${data.winner} nyert!`
            : (isWinner ? 'Gy≈ëzt√©l!' : 'Vesztett√©l!');
          statusBar.className = `status-bar ${isWinner ? 'winner' : 'loser'}`;
        }
        if (!isSpectator) {
          rematchBtn.style.display = 'inline-block';
        }
      }
    });
 
    // hiba
    socket.on('errorMessage', (data) => {
      if (data.spectatorMode) {
        isSpectator = true;
      } else {
        alert(data.message);
      }
    });
 
    // ellenfel kielepes
    socket.on('opponentLeft', (data) => {
      statusBar.textContent =data.message;
      statusBar.className = 'status-bar error';
      rematchBtn.style.display = 'none';
      rematchStatus.textContent = '';
    });
 
    // ujrajatek
    socket.on('rematchStatus', (data) => {
      if (data.readyCount === 1) {
        rematchStatus.textContent = '1/2 j√°t√©kos k√©sz az √∫j j√°t√©kra...';
      } else if (data.readyCount === 2) {
        rematchStatus.textContent = '√öj j√°t√©k indul!';
        setTimeout(() => {
          rematchStatus.textContent = '';
        }, 1000);
      }
    });
 
    // jatektabla frissites
    function updateBoard(board) {
      cells.forEach((cell, index) => {
        const value = board[index];
        cell.textContent = value === 'X' ? '‚ùå' : value === 'O' ? '‚≠ï' : '';
        cell.classList.toggle('taken', value !== '');
      });
    }
 
    // jatekosok megjelenjen
    function updatePlayers(players) {
      players.forEach(player => {
        const elem = player.symbol === 'X' 
          ? document.querySelector('#player1 .name')
          : document.querySelector('#player2 .name');
        elem.textContent = player.name;
        if (player.symbol === mySymbol) {
          elem.parentElement.classList.add('me');
        }
      });
    }
 
    // lepes
    cells.forEach(cell => {
      cell.addEventListener('click', () => {
        if (isSpectator) return;
        if (gameStatus !== 'playing') return;
        if (currentTurn !== mySymbol) return;
        const index = parseInt(cell.dataset.index);
        socket.emit('makeMove', { roomCode, index });
      });
    });
 
    // uj gami
    rematchBtn.addEventListener('click', () => {
      socket.emit('requestRematch', { roomCode });
      rematchBtn.disabled = true;
      rematchBtn.textContent = 'V√°rakoz√°s...';
    });
 
    // link a szobahoz
    shareBtn.addEventListener('click', () => {
      const url = window.location.origin + '/room/' + roomCode;
      navigator.clipboard.writeText(url).then(() => {
        shareBtn.textContent = '‚úì';
        setTimeout(() => {
          shareBtn.textContent = 'üìã';
        }, 2000);
      });
    });
</script>
</body>
</html>